import speedtest
import random
import colorsys
from datetime import datetime, timedelta, timezone
import glob
from io import BytesIO
import os
import requests
from PIL import Image, ImageDraw, ImageFont, ImageFilter
from core.bot_sys import is_admin
from modules.AI_GEMINI.pro_gemini import get_user_name_by_id
from zlapi.models import *

BACKGROUND_PATH = "background/"
CACHE_PATH = "modules/cache/"
OUTPUT_IMAGE_PATH = os.path.join(CACHE_PATH, "menu.png")

# HÃ m láº¥y tÃªn ngÆ°á»i dÃ¹ng tá»« ID (Cáº§n Ä‘iá»u chá»‰nh theo cÃ¡ch láº¥y tÃªn trong bot cá»§a báº¡n)
def get_user_name_by_id(bot, user_id):
    return "NgÆ°á»i DÃ¹ng"  # Äá»•i pháº§n nÃ y Ä‘á»ƒ láº¥y tÃªn tháº­t cá»§a ngÆ°á»i dÃ¹ng tá»« bot API

# HÃ m thá»±c hiá»‡n Ä‘o tá»‘c Ä‘á»™ máº¡ng
def run_speedtest_tag(bot, author_id, thread_id, thread_type, mention_id=None):
    try:
        st = speedtest.Speedtest()
        st.get_best_server()
        download = round(st.download() / 1_000_000, 2)  # Tá»‘c Ä‘á»™ download (Mbps)
        upload = round(st.upload() / 1_000_000, 2)  # Tá»‘c Ä‘á»™ upload (Mbps)
        ping = round(st.results.ping, 2)  # Ping (ms)

        # Tag ngÆ°á»i náº¿u cÃ³ mention
        if mention_id:
            mention_name = get_user_name_by_id(bot, mention_id)
            msg = f"ğŸ“¡ Káº¿t quáº£ Ä‘o máº¡ng cho @{mention_name}:\nâ¬‡ï¸ Download: {download} Mbps\nâ¬†ï¸ Upload: {upload} Mbps\nğŸ“¶ Ping: {ping} ms"
            mention_obj = Mention(mention_id, length=len(f"@{mention_name}"), offset=25)
        else:
            mention_name = get_user_name_by_id(bot, author_id)
            msg = f"ğŸ“¡ Káº¿t quáº£ Ä‘o máº¡ng cho @{mention_name}:\nâ¬‡ï¸ Download: {download} Mbps\nâ¬†ï¸ Upload: {upload} Mbps\nğŸ“¶ Ping: {ping} ms"
            mention_obj = Mention(author_id, length=len(f"@{mention_name}"), offset=25)

        bot.sendMessage(msg, thread_id, thread_type, mentions=[mention_obj])
    except Exception as e:
        bot.sendMessage(f"âŒ Lá»—i khi Ä‘o tá»‘c Ä‘á»™ máº¡ng: {e}", thread_id, thread_type)

# HÃ m xá»­ lÃ½ lá»‡nh -> tdm vÃ  cÃ¡c chá»©c nÄƒng liÃªn quan
def handle_tdm_command(bot, message, thread_id, thread_type):
    author_id = message.author
    text = message.text.lower().strip()
    mentions = message.mentions or []

    # Toggle Ä‘o máº¡ng
    if text.startswith("-> tdm check"):
        status = toggle_speedtest(thread_id)
        msg = "âœ… ÄÃ£ Báº¬T Ä‘o tá»‘c Ä‘á»™ máº¡ng!" if status else "âŒ ÄÃ£ Táº®T Ä‘o tá»‘c Ä‘á»™ máº¡ng!"
        bot.sendMessage(msg, thread_id, thread_type)
        return

    # Chá»‰ hiá»ƒn thá»‹ káº¿t quáº£ Ä‘o máº¡ng cho ngÆ°á»i gá»i
    if text == "-> tdm":
        bot.sendMessage("â³ Äang Ä‘o tá»‘c Ä‘á»™ máº¡ng cho báº¡n...", thread_id, thread_type)
        run_speedtest_tag(bot, author_id, thread_id, thread_type)
        return

    # Náº¿u cÃ³ tag ngÆ°á»i khÃ¡c: Ä‘o máº¡ng vÃ  tag há»
    if text.startswith("-> tdm") and mentions:
        target_id = mentions[0].id
        bot.sendMessage("â³ Äang Ä‘o máº¡ng cho ngÆ°á»i Ä‘Æ°á»£c tag...", thread_id, thread_type)
        run_speedtest_tag(bot, author_id, thread_id, thread_type, mention_id=target_id)
        return

    # Náº¿u nháº­p sai Ä‘á»‹nh dáº¡ng
    bot.sendMessage("âŒ Sai cÃº phÃ¡p! DÃ¹ng:\n-> tdm\n-> tdm check\n-> tdm @user", thread_id, thread_type)

# HÃ m báº­t/táº¯t chá»©c nÄƒng Ä‘o tá»‘c Ä‘á»™ máº¡ng (giáº£ láº­p)
def toggle_speedtest(thread_id):
    # Giáº£ láº­p báº­t/táº¯t. Thá»±c táº¿ báº¡n cÃ³ thá»ƒ lÆ°u tráº¡ng thÃ¡i vÃ o database hoáº·c file.
    status = random.choice([True, False])
    return status

# Pháº§n menu vÃ  cÃ¡c chá»©c nÄƒng liÃªn quan
def handle_menu_commands(message, message_object, thread_id, thread_type, author_id, bot):
    command_names = "".join([
        f"{get_user_name_by_id(bot, author_id)}\n"
        "âœ â˜ï¸ Tdm ({bot.prefix}tdm)\n"
        "âœ ğŸ³ Tdm @user ({bot.prefix}tdm)\n"
    ])
    
    image_path = generate_menu_image(bot, author_id, thread_id, thread_type)
    
    reaction = [
        "âŒ", "ğŸ¤§", "ğŸ", "ğŸ˜Š", "ğŸ”¥", "ğŸ‘", "ğŸ’–", "ğŸš€", "ğŸ˜", "ğŸ˜‚", "ğŸ˜¢", "ğŸ˜", "ğŸ™Œ", "ğŸ’ª", "ğŸŒŸ", "ğŸ€", "ğŸ‰", "ğŸ¦", "ğŸŒˆ", "ğŸ", 
        # ThÃªm cÃ¡c biá»ƒu tÆ°á»£ng cáº£m xÃºc á»Ÿ Ä‘Ã¢y
    ]
    
    bot.sendReaction(message_object, random.choice(reaction), thread_id, thread_type)
    bot.sendLocalImage(
        imagePath=image_path,
        message=Message(text=command_names, mention=Mention(author_id, length=len(f"{get_user_name_by_id(bot, author_id)}"), offset=0)),
        thread_id=thread_id,
        thread_type=thread_type,
        width=1920, height=600,
        ttl=60000
    )
    
    try:
        os.remove(image_path)
    except Exception as e:
        print(f"âŒ Lá»—i khi xÃ³a áº£nh: {e}")

# CÃ¡c hÃ m xá»­ lÃ½ áº£nh vÃ  mÃ u sáº¯c
def get_dominant_color(image_path):
    try:
        if not os.path.exists(image_path):
            print(f"File áº£nh khÃ´ng tá»“n táº¡i: {image_path}")
            return (0, 0, 0)
        
        img = Image.open(image_path).convert("RGB")
        img = img.resize((150, 150), Image.Resampling.LANCZOS)
        pixels = img.getdata()

        if not pixels:
            print(f"KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u pixel tá»« áº£nh: {image_path}")
            return (0, 0, 0)

        r, g, b = 0, 0, 0
        for pixel in pixels:
            r += pixel[0]
            g += pixel[1]
            b += pixel[2]

        total = len(pixels)
        if total == 0:
            return (0, 0, 0)
        
        r, g, b = r // total, g // total, b // total
        return (r, g, b)
    except Exception as e:
        print(f"Lá»—i khi phÃ¢n tÃ­ch mÃ u ná»•i báº­t: {e}")
        return (0, 0, 0)

def generate_menu_image(bot, author_id, thread_id, thread_type):
    images = glob.glob(BACKGROUND_PATH + "*.jpg") + glob.glob(BACKGROUND_PATH + "*.png") + glob.glob(BACKGROUND_PATH + "*.jpeg")
    
    if not images:
        print("âŒ KhÃ´ng tÃ¬m tháº¥y áº£nh trong thÆ° má»¥c background/")
        return None
    
    image_path = random.choice(images)
    
    try:
        size = (1920, 600)
        final_size = (1280, 380)
        bg_image = Image.open(image_path).convert("RGBA").resize(size, Image.Resampling.LANCZOS)
        bg_image = bg_image.filter(ImageFilter.GaussianBlur(radius=7))
        
        overlay = Image.new("RGBA", size, (0, 0, 0, 0))
        draw = ImageDraw.Draw(overlay)
        
        dominant_color = get_dominant_color(image_path)
        r, g, b = dominant_color
        
        # Váº½ lÃªn overlay hoáº·c thá»±c hiá»‡n cÃ¡c thao tÃ¡c vá»›i áº£nh
        
        final_image = Image.alpha_composite(bg_image, overlay)
        final_image_path = os.path.join(CACHE_PATH, "final_menu_image.png")
        final_image.save(final_image_path)
        return final_image_path
    
    except Exception as e:
        print(f"Lá»—i khi táº¡o áº£nh menu: {e}")
        return None

# CÃ¡c hÃ m khÃ¡c xá»­ lÃ½ download áº£nh avatar, mÃ u sáº¯c tÆ°Æ¡ng pháº£n, v.v. cÃ³ thá»ƒ giá»¯ láº¡i tÆ°Æ¡ng tá»±.
